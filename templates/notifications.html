{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Notifications</h2>

    <!-- Notification Settings -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Notification Settings</h4>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('notifications.update_settings') }}">
                <div class="mb-3">
                    <h5>Email Notifications</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="email_transactions" name="email_transactions" 
                               {% if settings.email_transactions %}checked{% endif %}>
                        <label class="form-check-label" for="email_transactions">
                            Transaction alerts
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="email_budgets" name="email_budgets"
                               {% if settings.email_budgets %}checked{% endif %}>
                        <label class="form-check-label" for="email_budgets">
                            Budget alerts
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="email_goals" name="email_goals"
                               {% if settings.email_goals %}checked{% endif %}>
                        <label class="form-check-label" for="email_goals">
                            Goal progress updates
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="email_bill_reminders" name="email_bill_reminders"
                               {% if settings.bill_reminders %}checked{% endif %}>
                        <label class="form-check-label" for="email_bill_reminders">
                            Bill payment reminders
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="email_spending_alerts" name="email_spending_alerts"
                               {% if settings.spending_alerts %}checked{% endif %}>
                        <label class="form-check-label" for="email_spending_alerts">
                            Spending alerts
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <h5>Push Notifications</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="push_transactions" name="push_transactions"
                               {% if settings.push_transactions %}checked{% endif %}>
                        <label class="form-check-label" for="push_transactions">
                            Transaction alerts
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="push_budgets" name="push_budgets"
                               {% if settings.push_budgets %}checked{% endif %}>
                        <label class="form-check-label" for="push_budgets">
                            Budget alerts
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="push_goals" name="push_goals"
                               {% if settings.push_goals %}checked{% endif %}>
                        <label class="form-check-label" for="push_goals">
                            Goal progress updates
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
            
            <div class="mt-4">
                <h5>Test Notifications</h5>
                <button id="test-email-btn" class="btn btn-sm btn-outline-primary">Test Email Notification</button>
            </div>
        </div>
    </div>

    <!-- Recent Notifications -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Recent Notifications</h4>
            <button id="mark-all-read-btn" class="btn btn-sm btn-outline-secondary">Mark All as Read</button>
        </div>
        <div class="card-body">
            {% if notifications %}
                <div class="list-group">
                {% for notification in notifications %}
                    <div class="list-group-item notification-item" data-id="{{ notification.id }}">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ notification.title }}</h5>
                            <small class="text-muted">{{ notification.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        <p class="mb-1">{{ notification.message }}</p>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="badge {% if notification.type == 'transaction' %}bg-info{% elif notification.type == 'budget' %}bg-warning{% elif notification.type == 'goal' %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ notification.type|title }}
                            </span>
                            {% if not notification.read %}
                                <span class="badge bg-primary">New</span>
                                <button class="btn btn-sm btn-link mark-read-btn" data-id="{{ notification.id }}">Mark as read</button>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No notifications yet.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Upcoming Bills -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Upcoming Bills</h4>
        </div>
        <div class="card-body">
            <div id="bill-reminders">
                <p class="text-center text-muted">Loading bill reminders...</p>
            </div>
        </div>
    </div>
    
    <!-- Budget Alerts -->
    <div class="card">
        <div class="card-header">
            <h4>Spending Alerts</h4>
        </div>
        <div class="card-body">
            <div id="spending-alerts">
                <p class="text-center text-muted">Loading spending alerts...</p>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    $(document).ready(function() {
        // Load bill reminders
        $.get('/api/notifications/bills', function(data) {
            const billsContainer = $('#bill-reminders');
            billsContainer.empty();
            
            if (data.reminders && data.reminders.length > 0) {
                const list = $('<ul class="list-group"></ul>');
                
                data.reminders.forEach(function(bill) {
                    const daysText = bill.days_remaining > 0 ? 
                        `Due in ${bill.days_remaining} days` : 
                        'Due today!';
                    
                    list.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${bill.name}</h6>
                                <small class="text-muted">${daysText} (${bill.due_date})</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">$${bill.amount.toFixed(2)}</span>
                        </li>
                    `);
                });
                
                billsContainer.append(list);
            } else {
                billsContainer.html('<p class="text-muted">No upcoming bills.</p>');
            }
        });
        
        // Load spending alerts
        $.get('/api/notifications/spending', function(data) {
            const alertsContainer = $('#spending-alerts');
            alertsContainer.empty();
            
            if (data.alerts && data.alerts.length > 0) {
                const list = $('<ul class="list-group"></ul>');
                
                data.alerts.forEach(function(alert) {
                    let alertClass = 'bg-info';
                    if (alert.percentage >= 90) {
                        alertClass = 'bg-danger';
                    } else if (alert.percentage >= 80) {
                        alertClass = 'bg-warning';
                    }
                    
                    list.append(`
                        <li class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${alert.message}</h6>
                            </div>
                            <div class="progress mt-2">
                                <div class="progress-bar ${alertClass}" role="progressbar" 
                                     style="width: ${alert.percentage}%" 
                                     aria-valuenow="${alert.percentage}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    ${alert.percentage.toFixed(1)}%
                                </div>
                            </div>
                        </li>
                    `);
                });
                
                alertsContainer.append(list);
            } else {
                alertsContainer.html('<p class="text-muted">No spending alerts.</p>');
            }
        });
        
        // Handle mark as read button clicks
        $('.mark-read-btn').on('click', function() {
            const notificationId = $(this).data('id');
            const button = $(this);
            
            $.ajax({
                url: '/api/notifications/mark-read',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: notificationId }),
                success: function(response) {
                    if (response.success) {
                        // Remove the "New" badge and the button
                        button.siblings('.badge.bg-primary').remove();
                        button.remove();
                    }
                }
            });
        });
        
        // Handle mark all as read button
        $('#mark-all-read-btn').on('click', function() {
            // Loop through all notifications and mark them as read
            $('.mark-read-btn').each(function() {
                $(this).click();
            });
        });
        
        // Handle test notification button
        $('#test-email-btn').on('click', function() {
            $.ajax({
                url: '/api/notifications/send-test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ type: 'email' }),
                success: function(response) {
                    alert(response.message);
                },
                error: function() {
                    alert('Failed to send test notification');
                }
            });
        });
    });
</script>
{% endblock %}
{% endblock %}